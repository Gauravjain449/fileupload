import React, { Component } from 'react';
import { CSVReader } from 'react-papaparse';
import ReactTable from 'react-table'
import 'react-table/react-table.css'
import axios from 'axios';

class FileUploadCSV extends Component {
    constructor(props) {
        super(props);
        this.fileInput = React.createRef();
        this.state = ({
            columns: { Header: '', accessor: '' },
            data: [],
            optionsData: []
        })
    }

    handleReadCSV = (rows) => {
        let { columns, data, optionsData } = this.state;
        columns = Object.keys(rows.data[0]).map((key, id) => {
            // if (key === 'Region' || key === 'Country' || key === 'Item Type' || key === 'Sales Channel' || key === 'Order Priority') {
            optionsData[key] = [];
            return {
                Header: key,
                accessor: key
            }
            // }
        });
        console.log(columns);
        console.log(optionsData);
        data = rows.data.slice(0);
        data.map((key) => {
            columns.map(header => {
                if (header.Header === 'Region' || header.Header === 'Country' || header.Header === 'Item Type' || header.Header === 'Sales Channel' || header.Header === 'Order Priority') {
                    if (optionsData[header.Header].indexOf(key[header.Header]) === -1) {
                        optionsData[header.Header].push(key[header.Header]);
                    }
                }
            })
        });

        console.log(optionsData);

        this.setState({
            columns, data, optionsData
        })
    }
    handleSaveDatabase = async (e) => {
        e.preventDefault();

        let chunk_size = 500;
        let arrData = []

        for (let index = 0; index < this.state.data.length; index += chunk_size) {
            arrData.push(this.state.data.slice(index, index + chunk_size));
            // Do something if you want with the group
        }
        console.log(arrData.length)
        for (let i = 0; i < arrData.length; i++) {
            await this.getTitle(arrData[i], i).then((res) => {
                console.log(res);
            })
        }
    }

    getTitle = (data, index) => {
        return new Promise((resolve, reject) => {
            axios({
                method: 'post',
                url: 'http://localhost:5000/addrecords', headers: {},
                data: {
                    foo: data,
                    index: index // This is the body part
                }
            }).then(response => {
                return resolve(response.data)
            })
                .catch(error => {
                    return reject(error.message)
                })
        })
    }


    handleOnError = (err, file, inputElem, reason) => {
        console.log(err);
    }

    handleImportOffer = () => {
        this.fileInput.current.click();
    }

    render() {
        return (
            <div>
                <CSVReader
                    onFileLoaded={this.handleReadCSV}
                    inputRef={this.fileInput}
                    style={{ display: 'none' }}
                    onError={this.handleOnError}
                    configOptions={{ header: true /* Header row support */ }}
                />
                <button onClick={this.handleImportOffer}>Import</button>

                {
                    this.state.data.length > 0 &&
                    (
                        <div>
                            <br />
                            <div className="container">
                                {this.state.columns.map((header, index) => {
                                    return (<div className="row" key={index}>
                                        <div className="col-sm">
                                            {header.Header}
                                        </div>
                                        <div className="col-sm">
                                            <div className="form-group col-md-8">
                                                <select className="form-control">
                                                    {
                                                        this.state.optionsData[header.Header].length > 0 && this.state.optionsData[header.Header].sort().map((option, i) => {
                                                            return <option key={option} title={option} value={option}>{option}</option>;
                                                        })
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    )

                                })}
                            </div>



                            {/* <ReactTable
                                data={data}
                                columns={columns}
                                defaultPageSize={10}
                                resizable={true}
                                className="table table-stripped"
                            /> */}
                            <button onClick={this.handleSaveDatabase}>Save to Database</button>

                        </div>
                    )
                }
            </div >
        );
    }
}

export default FileUploadCSV;
